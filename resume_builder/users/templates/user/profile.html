{% extends 'base.html' %}

{% block title %}Profile - Interview Assistant{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Welcome back!</h1>
        <p>{{ user.first_name|default:"User" }} {{ user.last_name|default:"" }}</p>
    </div>

    <div class="profile-info">
        <div class="info-section">
            <h3>üìä Account Statistics</h3>
            <div class="info-item">
                <span class="info-label">Login Count:</span>
                <span class="info-value">{{ user.login_count }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Last Login:</span>
                <span class="info-value">
                    <span id="last-login-time" data-utc="{{ user.last_login|date:'c' }}">{{ user.last_login|date:"M d, Y H:i" }}</span>
                    <small id="timezone-info" style="opacity: 0.7;"></small>
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Member Since:</span>
                <span class="info-value">
                    <span id="created-date" data-utc="{{ user.created_date|date:'c' }}">{{ user.created_date|date:"M d, Y" }}</span>
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Account Status:</span>
                <span class="info-value">{{ user.is_active|yesno:"Active,Inactive" }}</span>
            </div>
        </div>

        <div class="info-section">
            <h3>üîë Account Details</h3>
            <div class="info-item">
                <span class="info-label">User ID:</span>
                <span class="info-value">{{ user.user_id }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Email:</span>
                <span class="info-value">{{ user.email }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Staff Status:</span>
                <span class="info-value">{{ user.is_staff|yesno:"Yes,No" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Terms Accepted:</span>
                <span class="info-value">{{ user.terms_and_conditions_accepted|yesno:"‚úÖ,‚ùå" }}</span>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h2>Update Profile</h2>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="{{ form.timezone.id_for_label }}">{{ form.timezone.label }}</label>
                {{ form.timezone }}
                {% if form.timezone.errors %}
                    <div class="alert alert-error">{{ form.timezone.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.first_name.id_for_label }}">{{ form.first_name.label }}</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}
                    <div class="alert alert-error">{{ form.first_name.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.last_name.id_for_label }}">{{ form.last_name.label }}</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}
                    <div class="alert alert-error">{{ form.last_name.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                {{ form.email }}
                {% if form.email.errors %}
                    <div class="alert alert-error">{{ form.email.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    {{ form.terms_and_conditions_accepted }}
                    <label for="{{ form.terms_and_conditions_accepted.id_for_label }}">{{ form.terms_and_conditions_accepted.label }}</label>
                </div>
                {% if form.terms_and_conditions_accepted.errors %}
                    <div class="alert alert-error">{{ form.terms_and_conditions_accepted.errors }}</div>
                {% endif %}
            </div>

            <div class="actions">
                <button type="submit" class="btn btn-primary">Update Profile</button>
                <a href="{% url 'login' %}" class="btn btn-secondary">Logout</a>
            </div>
        </form>
    </div>
</div>

<script>
    // Function to convert UTC datetime to user's local timezone
    function convertToUserTimezone() {
        // Get user's timezone
        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const timezoneAbbr = new Date().toLocaleDateString('en', {timeZoneName:'short'}).split(', ')[1];
        
        // Update timezone info display
        const timezoneInfo = document.getElementById('timezone-info');
        if (timezoneInfo) {
            timezoneInfo.textContent = `(${userTimezone})`;
        }

        // Convert last login time
        const lastLoginElement = document.getElementById('last-login-time');
        if (lastLoginElement) {
            const utcTime = lastLoginElement.getAttribute('data-utc');
            if (utcTime) {
                const date = new Date(utcTime);
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                };
                lastLoginElement.textContent = date.toLocaleString('en-US', options);
            }
        }

        // Convert created date
        const createdDateElement = document.getElementById('created-date');
        if (createdDateElement) {
            const utcTime = createdDateElement.getAttribute('data-utc');
            if (utcTime) {
                const date = new Date(utcTime);
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit'
                };
                createdDateElement.textContent = date.toLocaleDateString('en-US', options);
            }
        }
    }

    // Run the conversion when the page loads
    document.addEventListener('DOMContentLoaded', convertToUserTimezone);
</script>
{% endblock %}